version: "0.1"

services:
  arrowhead-database:
    extends:
      file: arrowhead-core/docker-compose.yaml
      service: arrowhead-database

  serviceregistry-healthcheck:
    container_name: serviceregistry-healthcheck
    build: 
      context: serviceregistry-healthcheck
      dockerfile: Dockerfile
    environment:
      CERT_FILE_PATH: ./certificates/sysop-cert.pem
      KEY_FILE_PATH: ./certificates/sysop-key.pem
    env_file:
      - .env
    
  arrowhead-serviceregistry:
    container_name: arrowhead-serviceregistry
    image: aitiaiiot/arrowhead-system:4.6.1
    environment:
      SYSTEM_NAME: serviceregistry
    env_file:
      - .enviroment.arrowheadcore.env
    volumes:
      - ./arrowhead-core/serviceregistry/application.properties:/opt/arrowhead/application.properties
      - ./certificates/truststore.p12:/opt/arrowhead/certificates/truststore.p12
      - ./certificates/serviceregistry.p12:/opt/arrowhead/certificates/serviceregistry.p12
    ports:
      - 8443:8443
  
  arrowhead-authorization:
    container_name: arrowhead-authorization
    image: aitiaiiot/arrowhead-system:4.6.1
    environment:
      SYSTEM_NAME: authorization
    env_file:
      - .enviroment.arrowheadcore.env
    volumes:
      - ./arrowhead-core/authorization/application.properties:/opt/arrowhead/application.properties
      - ./certificates/truststore.p12:/opt/arrowhead/certificates/truststore.p12
      - ./certificates/authorization.p12:/opt/arrowhead/certificates/authorization.p12
    ports:
      - 8445:8445
      
  arrowhead-orchestrator:
    container_name: arrowhead-orchestrator
    image: aitiaiiot/arrowhead-system:4.6.1
    environment:
      SYSTEM_NAME: orchestrator
    env_file:
      - .enviroment.arrowheadcore.env
    volumes:
      - ./arrowhead-core/orchestrator/application.properties:/opt/arrowhead/application.properties
      - ./certificates/truststore.p12:/opt/arrowhead/certificates/truststore.p12
      - ./certificates/orchestrator.p12:/opt/arrowhead/certificates/orchestrator.p12
    ports:
      - 8441:8441

  work-handler:
    container_name: work-handler
    ports:
      - "8001:8001"
    build: 
      context: work-handler
      dockerfile: ../work-handler.Dockerfile
    depends_on:
      serviceregistry-healthcheck:
        condition: service_completed_successfully
    env_file:
      - .env
    volumes:
      - ./certificates:/app/certificates
      - ./.enviroment.work-handler.env:/app/.env

  digital-twin-hub:
    container_name: digital-twin-hub
    ports:
      - "8080:8080"
    build: 
      context: digital-twin-hub
      dockerfile: ../digital-twin-hub.Dockerfile
    depends_on:
      serviceregistry-healthcheck:
        condition: service_completed_successfully
    env_file:
      - .env
    volumes:
      - ./certificates:/app/certificates
      - ./.enviroment.digital-twin-hub.env:/app/.env

  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3.12.12
    ports:
      - "30001:5672"

  mongodb:
    container_name: mongodb
    image: mongo:latest
    ports:
      - "30000:27017"
    volumes:
      - mongo-data:/data/db
  
volumes:
  arrowhead-database:
  mongo-data: